(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const m of n.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&c(m)}).observe(document,{childList:!0,subtree:!0});function t(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(e){if(e.ep)return;e.ep=!0;const n=t(e);fetch(e.href,n)}})();console.log("popup.js loaded successfully");const C={SCOPES:["https://www.googleapis.com/auth/spreadsheets"],SHEET_NAME:"Classification History",HEADERS:["Subject","URL","Timestamp"]},w={SPREADSHEET_ID:"spreadsheetId",PREVIOUS_SPREADSHEET_ID:"previousSpreadsheetId"},T=async()=>{try{return new Promise((o,s)=>{chrome.identity.getAuthToken({interactive:!0},t=>{chrome.runtime.lastError?s(chrome.runtime.lastError):o(t)})})}catch(o){throw console.error("Auth error:",o),o}};document.addEventListener("DOMContentLoaded",async()=>{const o=document.getElementById("classify");document.getElementById("view-responses");const s=document.getElementById("responses-list"),t=document.getElementById("responses-table"),c=async(i,r)=>{const l=new Date().toISOString();chrome.storage.sync.get("responses",a=>{const h=a.responses||[];h.push({subject:i,url:r,timestamp:l}),chrome.storage.sync.set({responses:h},()=>{console.log("Classification stored in Chrome storage:",{subject:i,url:r,timestamp:l})})});try{const{spreadsheetId:a}=await chrome.storage.sync.get("spreadsheetId");a&&(await B(i,r,l),console.log("Classification stored in Google Sheets"))}catch(a){console.error("Failed to store in Google Sheets:",a)}},e=i=>{chrome.storage.sync.get("responses",r=>{const l=r.responses||[];i>=0&&i<l.length&&(l.splice(i,1),chrome.storage.sync.set({responses:l},()=>{console.log(`Removed classification at index ${i}`),n()}))})},n=()=>{chrome.storage.sync.get("responses",i=>{const r=i.responses||[];if(s.innerHTML="",r.length===0){console.log("No past classifications found");const a=document.createElement("tr"),h=document.createElement("td");h.colSpan=4,h.textContent="No past classifications found.",h.style.textAlign="center",a.appendChild(h),s.appendChild(a),L();return}console.log("Displaying stored responses:",r),[...r].reverse().forEach((a,h)=>{const y=document.createElement("tr"),S=document.createElement("td");S.textContent=a.subject||"N/A",y.appendChild(S);const x=document.createElement("td"),f=document.createElement("a");f.href=a.url,f.textContent=a.url.length>50?a.url.substring(0,47)+"...":a.url,f.title=a.url,f.target="_blank",x.appendChild(f),x.style.wordWrap="break-word",x.style.maxWidth="200px",y.appendChild(x);const E=document.createElement("td");E.textContent=new Date(a.timestamp).toLocaleString(),y.appendChild(E);const p=document.createElement("td"),d=document.createElement("button");d.textContent="X",d.style.color="white",d.style.backgroundColor="black",d.style.border="none",d.style.cursor="pointer",d.style.padding="2px 5px",d.style.fontSize="12px",d.style.borderRadius="3px",d.addEventListener("click",()=>{e(r.length-1-h)}),p.appendChild(d),y.appendChild(p),s.appendChild(y)}),t.style.display="table",L()})},m=(i=!1,r)=>{const l=document.getElementById("result"),a=document.getElementById("extracted-text"),h=document.getElementById("source");r.disabled=!0,r.style.backgroundColor="#cccccc",r.innerText="Classifying...",l.innerText="",a.innerText="",a.style.display="none",h.innerText="",chrome.tabs.query({active:!0,currentWindow:!0},y=>{if(y.length===0){console.error("No active tab found"),r.disabled=!1,r.style.backgroundColor="",r.innerText=i?"Classify using Local Model":"Classify",l.innerText="No active tab found!";return}const S=new URL(y[0].url),x={target:{tabId:y[0].id},func:f=>{if(f==="twitter.com"||f==="x.com"){const p=document.querySelector('[data-testid="tweetText"]');return p?{text:p.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const E=["#mw-content-text","main","article"];for(let p of E){const d=document.querySelector(p);if(d&&d.innerText.trim())return{text:d.innerText.substring(0,5e3),source:p}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[S.hostname]};chrome.scripting.executeScript(x,f=>{if(chrome.runtime.lastError){console.error("Error:",chrome.runtime.lastError),r.disabled=!1,r.style.backgroundColor="",r.innerText=i?"Classify using Local Model":"Classify",l.innerText=`Error: ${chrome.runtime.lastError.message}`;return}const E=f[0].result;h.innerText=`Extracted Text Source: ${E.source}`,a.style.display="block",a.innerText=E.text,chrome.runtime.sendMessage({action:"classifyPage",content:E.text,useLocalModel:i},p=>{if(r.disabled=!1,r.style.backgroundColor="",r.innerText=i?"Classify using Local Model":"Classify",p&&p.subject){l.innerHTML=`This page is classified as: <span>${p.subject}</span>`,c(p.subject,y[0].url);const d=document.getElementById("explanation");if(d&&d.remove(),p.explanation){const b=document.createElement("div");b.id="explanation",b.innerHTML=`<strong>Explanation:</strong> <em>${p.explanation}</em>`,b.style.marginBottom="20px";const I=document.getElementById("view-responses");I.parentNode.insertBefore(b,I)}}else l.innerText="Classification failed."})})})};o?o.addEventListener("click",()=>m(!1,o)):console.error("Classify button not found");const u=document.getElementById("view-responses");u?u.addEventListener("click",()=>{const i=u.querySelector(".caret"),r=u.querySelector(".expander-text"),l=document.getElementById("hexagon-visualization"),a=document.getElementById("responses-table");document.getElementById("download-csv"),i.classList.contains("expanded")?(l.style.display="none",a.style.display="none",i.classList.remove("expanded"),r.textContent="View Past Classifications"):(n(),l.style.display="flex",a.style.display="table",i.classList.add("expanded"),r.textContent="Hide Past Classifications")}):console.error("Expander not found");const g=document.getElementById("classifyLocalButton");g?chrome.runtime.sendMessage({action:"checkModelAvailability"},i=>{i?(g.style.backgroundColor="",g.addEventListener("click",()=>m(!0,g))):(g.disabled=!0,g.style.backgroundColor="#cccccc",g.innerText="No local model available",g.style.cursor="not-allowed")}):console.error("Local classification button not found");const v=document.getElementById("download-csv");v?v.addEventListener("click",R):console.error("Download CSV button not found"),k()});const L=()=>{chrome.storage.sync.get("responses",o=>{const s=o.responses||[],t={Mathematics:{count:0,color:"#F9584B"},Science:{count:0,color:"#E6B710"},"Social Studies":{count:0,color:"#32B7A9"},"Language Arts":{count:0,color:"#4E62E0"}};s.forEach(e=>{t[e.subject]&&(t[e.subject].count+=1)});const c=document.getElementById("hexagon-visualization");c.innerHTML="";for(const[e,{count:n,color:m}]of Object.entries(t)){const u=document.createElement("div");u.className="hexagon",u.style.backgroundColor=n>0?m:"#ffffff",u.style.color=n>0?"white":"black",u.innerHTML=`
        <div class="hexagon-content">
          <p>${e}</p>
          <p>[${n}]</p>
        </div>
      `,c.appendChild(u)}})},A=async()=>{const o=await T(),s=await chrome.storage.sync.get("spreadsheetId");if(s.spreadsheetId)try{if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s.spreadsheetId}`,{headers:{Authorization:`Bearer ${o}`}})).ok)return s.spreadsheetId}catch{console.log("Stored spreadsheet no longer accessible, creating new one")}const t=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:"Web Page Classifications"},sheets:[{properties:{title:C.SHEET_NAME}}]})});if(!t.ok)throw new Error("Failed to create spreadsheet");const{spreadsheetId:c}=await t.json();return await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${c}/values/${C.SHEET_NAME}!A1:C1?valueInputOption=RAW`,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({values:[C.HEADERS]})}),await chrome.storage.sync.set({spreadsheetId:c}),c},B=async(o,s,t)=>{const c=await T();if(!c)throw new Error("Not authenticated");const{spreadsheetId:e}=await chrome.storage.sync.get("spreadsheetId");if(!e)throw new Error("No spreadsheet connected");const n=`${C.SHEET_NAME}!A:C`,m=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${n}:append?valueInputOption=USER_ENTERED`,u=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"},body:JSON.stringify({values:[[o,s,new Date(t).toLocaleString()]]})});if(!u.ok){const g=await u.json();throw console.error("Sheet API Error:",g),new Error("Failed to append to Google Sheet")}return u.json()},k=()=>{const o=document.createElement("div");o.id="sheet-settings",o.style.marginTop="20px",o.style.borderTop="1px solid #ccc",o.style.paddingTop="10px",chrome.storage.sync.get("spreadsheetId",async s=>{if(s.spreadsheetId){const t=await T(),e=await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s.spreadsheetId}?fields=properties.title`,{headers:{Authorization:`Bearer ${t}`}})).json();o.innerHTML=`
        <p>Connected to Sheet: ${e.properties.title}</p>
        <button id="disconnect-sheet">Disconnect Sheet</button>
        <button id="open-sheet">Open Sheet</button>
      `}else o.innerHTML=`
        <p>No Google Sheet connected</p>
        <button id="connect-sheet" style="background-color: #008000; &:hover { background-color: #006400; }">Connect to Google Sheets (beta)</button>
      `}),document.body.appendChild(o),document.addEventListener("click",async s=>{if(s.target.id==="connect-sheet")try{const{previousSpreadsheetId:t}=await chrome.storage.sync.get(w.PREVIOUS_SPREADSHEET_ID);if(t)try{const e=await T();if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}`,{headers:{Authorization:`Bearer ${e}`}})).ok){await chrome.storage.sync.set({[w.SPREADSHEET_ID]:t}),location.reload();return}}catch{console.log("Previous spreadsheet no longer accessible")}const c=await A();location.reload()}catch(t){console.error("Failed to connect sheet:",t)}else if(s.target.id==="disconnect-sheet"){const{spreadsheetId:t}=await chrome.storage.sync.get(w.SPREADSHEET_ID);t&&await chrome.storage.sync.set({[w.PREVIOUS_SPREADSHEET_ID]:t}),await chrome.storage.sync.remove(w.SPREADSHEET_ID),location.reload()}else if(s.target.id==="open-sheet"){const{spreadsheetId:t}=await chrome.storage.sync.get(w.SPREADSHEET_ID);t&&window.open(`https://docs.google.com/spreadsheets/d/${t}`)}})},D=o=>{const s=["Subject","URL","Timestamp"],t=o.map(c=>[c.subject,c.url,new Date(c.timestamp).toLocaleString()]);return[s,...t].map(c=>c.map(e=>`"${e}"`).join(",")).join(`
`)},R=()=>{chrome.storage.sync.get("responses",o=>{const s=o.responses||[];if(s.length===0){alert("No classification history to download.");return}const t=D(s),c=new Blob([t],{type:"text/csv;charset=utf-8;"}),e=URL.createObjectURL(c),n=document.createElement("a"),m=new Date().toISOString().split("T")[0];n.setAttribute("href",e),n.setAttribute("download",`classification-history-${m}.csv`),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(e)})};
