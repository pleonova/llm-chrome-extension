(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))d(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&d(h)}).observe(document,{childList:!0,subtree:!0});function o(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function d(e){if(e.ep)return;e.ep=!0;const a=o(e);fetch(e.href,a)}})();console.log("popup.js loaded successfully");const b={SCOPES:["https://www.googleapis.com/auth/spreadsheets"],SHEET_NAME:"Classification History",HEADERS:["Subject","URL","Timestamp"]},T=async()=>{try{return new Promise((t,n)=>{chrome.identity.getAuthToken({interactive:!0},o=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(o)})})}catch(t){throw console.error("Auth error:",t),t}};document.addEventListener("DOMContentLoaded",async()=>{const t=document.getElementById("classify"),n=document.getElementById("view-responses"),o=document.getElementById("responses-list"),d=document.getElementById("responses-table"),e=async(i,c)=>{const s=new Date().toISOString();chrome.storage.sync.get("responses",l=>{const u=l.responses||[];u.push({subject:i,url:c,timestamp:s}),chrome.storage.sync.set({responses:u},()=>{console.log("Classification stored in Chrome storage:",{subject:i,url:c,timestamp:s})})});try{const{spreadsheetId:l}=await chrome.storage.sync.get("spreadsheetId");l&&(await L(i,c,s),console.log("Classification stored in Google Sheets"))}catch(l){console.error("Failed to store in Google Sheets:",l)}},a=i=>{chrome.storage.sync.get("responses",c=>{const s=c.responses||[];i>=0&&i<s.length&&(s.splice(i,1),chrome.storage.sync.set({responses:s},()=>{console.log(`Removed classification at index ${i}`),h()}))})},h=()=>{chrome.storage.sync.get("responses",i=>{const c=i.responses||[];if(o.innerHTML="",c.length===0){console.log("No past classifications found");const s=document.createElement("tr"),l=document.createElement("td");l.colSpan=4,l.textContent="No past classifications found.",l.style.textAlign="center",s.appendChild(l),o.appendChild(s),v();return}console.log("Displaying stored responses:",c),c.forEach((s,l)=>{const u=document.createElement("tr"),f=document.createElement("td");f.textContent=s.subject||"N/A",u.appendChild(f);const x=document.createElement("td"),y=document.createElement("a");y.href=s.url,y.textContent=s.url.length>50?s.url.substring(0,47)+"...":s.url,y.title=s.url,y.target="_blank",x.appendChild(y),x.style.wordWrap="break-word",x.style.maxWidth="200px",u.appendChild(x);const E=document.createElement("td");E.textContent=new Date(s.timestamp).toLocaleString(),u.appendChild(E);const g=document.createElement("td"),r=document.createElement("button");r.textContent="X",r.style.color="white",r.style.backgroundColor="black",r.style.border="none",r.style.cursor="pointer",r.style.padding="2px 5px",r.style.fontSize="12px",r.style.borderRadius="3px",r.addEventListener("click",()=>{a(l)}),g.appendChild(r),u.appendChild(g),o.appendChild(u)}),d.style.display="table",v()})},p=(i=!1,c)=>{const s=document.getElementById("result"),l=document.getElementById("extracted-text"),u=document.getElementById("source");c.disabled=!0,c.style.backgroundColor="#cccccc",c.innerText="Classifying...",s.innerText="",l.innerText="",l.style.display="none",u.innerText="",chrome.tabs.query({active:!0,currentWindow:!0},f=>{if(f.length===0){console.error("No active tab found"),c.disabled=!1,c.style.backgroundColor="",c.innerText=i?"Classify using Local Model":"Classify",s.innerText="No active tab found!";return}const x=new URL(f[0].url),y={target:{tabId:f[0].id},func:E=>{if(E==="twitter.com"||E==="x.com"){const r=document.querySelector('[data-testid="tweetText"]');return r?{text:r.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const g=["#mw-content-text","main","article"];for(let r of g){const w=document.querySelector(r);if(w&&w.innerText.trim())return{text:w.innerText.substring(0,5e3),source:r}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[x.hostname]};chrome.scripting.executeScript(y,E=>{if(chrome.runtime.lastError){console.error("Error:",chrome.runtime.lastError),c.disabled=!1,c.style.backgroundColor="",c.innerText=i?"Classify using Local Model":"Classify",s.innerText=`Error: ${chrome.runtime.lastError.message}`;return}const g=E[0].result;u.innerText=`Extracted Text Source: ${g.source}`,l.style.display="block",l.innerText=g.text,chrome.runtime.sendMessage({action:"classifyPage",content:g.text,useLocalModel:i},r=>{if(c.disabled=!1,c.style.backgroundColor="",c.innerText=i?"Classify using Local Model":"Classify",r&&r.subject){s.innerHTML=`This page is classified as: <span>${r.subject}</span>`,e(r.subject,f[0].url);const w=document.getElementById("explanation");if(w&&w.remove(),r.explanation){const C=document.createElement("div");C.id="explanation",C.innerHTML=`<strong>Explanation:</strong> <em>${r.explanation}</em>`,C.style.marginBottom="20px";const S=document.getElementById("view-responses");S.parentNode.insertBefore(C,S)}}else s.innerText="Classification failed."})})})};t?t.addEventListener("click",()=>p(!1,t)):console.error("Classify button not found"),n?n.addEventListener("click",()=>{console.log("View Past Classifications button clicked"),h()}):console.error("View Past Classifications button not found");const m=document.getElementById("classifyLocalButton");m?chrome.runtime.sendMessage({action:"checkModelAvailability"},i=>{i?m.addEventListener("click",()=>p(!0,m)):(m.disabled=!0,m.style.backgroundColor="#cccccc",m.innerText="No local model available",m.style.cursor="not-allowed")}):console.error("Local classification button not found"),B()});const v=()=>{chrome.storage.sync.get("responses",t=>{const n=t.responses||[],o={Mathematics:{count:0,color:"#F9584B"},Science:{count:0,color:"#E6B710"},"Social Studies":{count:0,color:"#32B7A9"},"Language Arts":{count:0,color:"#4E62E0"}};n.forEach(e=>{o[e.subject]&&(o[e.subject].count+=1)});const d=document.getElementById("hexagon-visualization");d.innerHTML="";for(const[e,{count:a,color:h}]of Object.entries(o)){const p=document.createElement("div");p.className="hexagon",p.style.backgroundColor=a>0?h:"#ffffff",p.style.color=a>0?"white":"black",p.innerHTML=`
        <div class="hexagon-content">
          <p>${e}</p>
          <p>[${a}]</p>
        </div>
      `,d.appendChild(p)}})},I=async()=>{const t=await T(),n=await chrome.storage.sync.get("spreadsheetId");if(n.spreadsheetId)try{if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${n.spreadsheetId}`,{headers:{Authorization:`Bearer ${t}`}})).ok)return n.spreadsheetId}catch{console.log("Stored spreadsheet no longer accessible, creating new one")}const o=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:"Web Page Classifications"},sheets:[{properties:{title:b.SHEET_NAME}}]})});if(!o.ok)throw new Error("Failed to create spreadsheet");const{spreadsheetId:d}=await o.json();return await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${d}/values/${b.SHEET_NAME}!A1:C1?valueInputOption=RAW`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({values:[b.HEADERS]})}),await chrome.storage.sync.set({spreadsheetId:d}),d},L=async(t,n,o)=>{const d=await T();if(!d)throw new Error("Not authenticated");const{spreadsheetId:e}=await chrome.storage.sync.get("spreadsheetId");if(!e)throw new Error("No spreadsheet connected");const a=`${b.SHEET_NAME}!A:C`,h=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${a}:append?valueInputOption=USER_ENTERED`,p=await fetch(h,{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({values:[[t,n,new Date(o).toLocaleString()]]})});if(!p.ok){const m=await p.json();throw console.error("Sheet API Error:",m),new Error("Failed to append to Google Sheet")}return p.json()},B=()=>{const t=document.createElement("div");t.id="sheet-settings",t.style.marginTop="20px",t.style.borderTop="1px solid #ccc",t.style.paddingTop="10px",chrome.storage.sync.get("spreadsheetId",async n=>{if(n.spreadsheetId){const o=await T(),e=await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${n.spreadsheetId}?fields=properties.title`,{headers:{Authorization:`Bearer ${o}`}})).json();t.innerHTML=`
        <p>Connected to Sheet: ${e.properties.title}</p>
        <button id="disconnect-sheet">Disconnect Sheet</button>
        <button id="open-sheet">Open Sheet</button>
      `}else t.innerHTML=`
        <p>No Google Sheet connected</p>
        <button id="connect-sheet">Connect to Google Sheets</button>
      `}),document.body.appendChild(t),document.addEventListener("click",async n=>{if(n.target.id==="connect-sheet")try{const o=await I();location.reload()}catch(o){console.error("Failed to connect sheet:",o)}else if(n.target.id==="disconnect-sheet")await chrome.storage.sync.remove("spreadsheetId"),location.reload();else if(n.target.id==="open-sheet"){const{spreadsheetId:o}=await chrome.storage.sync.get("spreadsheetId");o&&window.open(`https://docs.google.com/spreadsheets/d/${o}`)}})};
