(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const c of t)if(c.type==="childList")for(const h of c.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(t){const c={};return t.integrity&&(c.integrity=t.integrity),t.referrerPolicy&&(c.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?c.credentials="include":t.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(t){if(t.ep)return;t.ep=!0;const c=e(t);fetch(t.href,c)}})();console.log("popup.js loaded successfully");const B={SCOPES:["https://www.googleapis.com/auth/spreadsheets"],SHEET_NAME:"Classification History",HEADERS:["Subject","URL","Count","Initial Timestamp","Latest Timestamp"]},b={SPREADSHEET_ID:"spreadsheetId",PREVIOUS_SPREADSHEET_ID:"previousSpreadsheetId"},L=async()=>{try{return new Promise((n,o)=>{chrome.identity.getAuthToken({interactive:!0},e=>{chrome.runtime.lastError?o(chrome.runtime.lastError):n(e)})})}catch(n){throw console.error("Auth error:",n),n}},C=5;let w=1;async function j(){const n=document.getElementById("extracted-text"),o=document.getElementById("source");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e){console.error("No active tab found");return}const s=new URL(e.url),t={target:{tabId:e.id},func:g=>{if(g==="twitter.com"||g==="x.com"){const f=document.querySelector('[data-testid="tweetText"]');return f?{text:f.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const y=["#mw-content-text","main","article"];for(let f of y){const i=document.querySelector(f);if(i&&i.innerText.trim())return{text:i.innerText.substring(0,5e3),source:f}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[s.hostname]},[c]=await chrome.scripting.executeScript(t),h=c.result;o.innerText=`Extracted Text (Source: ${h.source})`,n.style.display="block",n.contentEditable="true",n.innerText=h.text,H()}catch(e){console.error("Error extracting text:",e),n.style.display="block",n.innerText="Error extracting text from page."}}let D;const H=()=>{const n=document.getElementById("extracted-text"),o=document.getElementById("extracted-text-edited"),e=document.getElementById("source"),s=e.innerText;n.addEventListener("input",()=>{D&&clearTimeout(D),D=setTimeout(()=>{const t=n.innerText;o.innerText=t,e.innerText.endsWith("_edited")||(e.innerText=s.replace(")","_edited)")),console.log("Autosaved edited text")},500)})};document.addEventListener("DOMContentLoaded",async()=>{const n=document.getElementById("classify");document.getElementById("view-responses"),document.getElementById("responses-list"),document.getElementById("responses-table"),await j();const o=async(i,l)=>{const p=new Date().toISOString();chrome.storage.sync.get("responses",d=>{let m=d.responses||[];const E=m.findIndex(T=>T.url===l&&T.subject===i);if(E!==-1){const T=Number(m[E].count)||1;m[E]={...m[E],count:T+1,lastTimestamp:p}}else m.push({subject:i,url:l,count:1,firstTimestamp:p,lastTimestamp:p});chrome.storage.sync.set({responses:m},()=>{s()})});try{const{spreadsheetId:d}=await chrome.storage.sync.get("spreadsheetId");d&&(await _(i,l,p),console.log("Classification stored in Google Sheets"))}catch(d){console.error("Failed to store in Google Sheets:",d)}},e=(i,l)=>{chrome.storage.sync.get("responses",p=>{const m=(p.responses||[]).filter(E=>!(E.url===i&&E.subject===l));chrome.storage.sync.set({responses:m},()=>{console.log("Classification removed"),s()})})},s=()=>{chrome.storage.sync.get("responses",i=>{const l=i.responses||[],p=document.getElementById("responses-list");if(document.getElementById("responses-table"),p.innerHTML="",l.length===0){console.log("No past classifications found");const r=document.createElement("tr"),a=document.createElement("td");a.colSpan=6,a.textContent="No past classifications found.",a.style.textAlign="center",r.appendChild(a),p.appendChild(r),document.querySelector(".pagination-controls").style.display="none",$();return}const d=l.reduce((r,a)=>{const u=`${a.url}-${a.subject}`;return r[u]?r[u]={...a,count:a.count||r[u].count,firstTimestamp:a.firstTimestamp<r[u].firstTimestamp?a.firstTimestamp:r[u].firstTimestamp,lastTimestamp:a.lastTimestamp>r[u].lastTimestamp?a.lastTimestamp:r[u].lastTimestamp}:r[u]={...a,count:a.count||1,firstTimestamp:a.firstTimestamp||a.timestamp,lastTimestamp:a.lastTimestamp||a.timestamp},r},{}),m=Object.values(d).sort((r,a)=>new Date(a.lastTimestamp)-new Date(r.lastTimestamp)),E=Math.ceil(m.length/C),T=(w-1)*C,A=Math.min(T+C,m.length),v=m.slice(T,A);document.querySelector(".pagination-controls").style.display="block",document.getElementById("prev-page").disabled=w===1,document.getElementById("next-page").disabled=w===E,document.getElementById("page-info").textContent=`Page ${w} of ${E||1}`,v.forEach(r=>{const a=document.createElement("tr"),u=document.createElement("td");u.textContent=r.subject||"N/A",a.appendChild(u);const S=document.createElement("td"),I=document.createElement("a");I.href=r.url,I.textContent=r.url.length>50?r.url.substring(0,47)+"...":r.url,I.title=r.url,I.target="_blank",S.appendChild(I),S.style.wordWrap="break-word",S.style.maxWidth="200px",a.appendChild(S);const k=document.createElement("td");k.textContent=r.count,a.appendChild(k);const P=document.createElement("td");P.textContent=new Date(r.firstTimestamp).toLocaleString(),a.appendChild(P);const R=document.createElement("td");R.textContent=new Date(r.lastTimestamp).toLocaleString(),a.appendChild(R);const O=document.createElement("td"),x=document.createElement("button");x.textContent="X",x.style.color="white",x.style.backgroundColor="black",x.style.border="none",x.style.cursor="pointer",x.style.padding="2px 5px",x.style.fontSize="12px",x.style.borderRadius="3px",x.addEventListener("click",()=>{e(r.url,r.subject)}),O.appendChild(x),a.appendChild(O),p.appendChild(a)}),$()})},t=document.getElementById("prev-page"),c=document.getElementById("next-page");t.addEventListener("click",()=>{w>1&&(w--,s())}),c.addEventListener("click",()=>{chrome.storage.sync.get("responses",i=>{const l=i.responses||[],p=Math.ceil(l.length/C);w<p&&(w++,s())})});const h=(i=!1,l)=>{const p=document.getElementById("result"),d=document.getElementById("extracted-text"),m=document.getElementById("extracted-text-edited"),E=document.getElementById("source");l.disabled=!0,l.style.backgroundColor="#cccccc",l.innerText="Classifying...";const A=E.innerText.endsWith("_edited")?m.innerText:d.innerText;chrome.tabs.query({active:!0,currentWindow:!0},v=>{if(v.length===0){console.error("No active tab found"),l.disabled=!1,l.style.backgroundColor="",l.innerText=i?"Classify using Local Model":"Classify",p.innerText="No active tab found!";return}chrome.runtime.sendMessage({action:"classifyPage",content:A,useLocalModel:i},r=>{if(l.disabled=!1,l.style.backgroundColor="",l.innerText=i?"Classify using Local Model":"Classify",r&&r.subject){p.innerHTML=`This page is classified as: <span>${r.subject}</span>`,o(r.subject,v[0].url);const a=document.getElementById("explanation");if(a&&a.remove(),r.explanation){const u=document.createElement("div");u.id="explanation",u.innerHTML=`<strong>Explanation:</strong> <em>${r.explanation}</em>`,u.style.marginBottom="20px";const S=document.getElementById("view-responses");S.parentNode.insertBefore(u,S)}}else p.innerText="Classification failed."})})};n?n.addEventListener("click",()=>h(!1,n)):console.error("Classify button not found");const g=document.getElementById("view-responses");g?g.addEventListener("click",()=>{const i=g.querySelector(".caret"),l=g.querySelector(".expander-text"),p=document.getElementById("hexagon-visualization"),d=document.getElementById("responses-table");document.getElementById("download-csv"),i.classList.contains("expanded")?(p.style.display="none",d.style.display="none",i.classList.remove("expanded"),l.textContent="View Past Classifications"):(s(),p.style.display="flex",d.style.display="table",i.classList.add("expanded"),l.textContent="Hide Past Classifications")}):console.error("Expander not found");const y=document.getElementById("classifyLocalButton");y?chrome.runtime.sendMessage({action:"checkModelAvailability"},i=>{i?(y.style.backgroundColor="",y.addEventListener("click",()=>h(!0,y))):(y.disabled=!0,y.style.backgroundColor="#cccccc",y.innerText="No local model available",y.style.cursor="not-allowed")}):console.error("Local classification button not found");const f=document.getElementById("download-csv");f?f.addEventListener("click",z):console.error("Download CSV button not found"),M()});const $=()=>{chrome.storage.sync.get("responses",n=>{const o=n.responses||[],e={Mathematics:{count:0,color:"#F9584B"},Science:{count:0,color:"#E6B710"},"Social Studies":{count:0,color:"#32B7A9"},"Language Arts":{count:0,color:"#4E62E0"}};o.forEach(t=>{e[t.subject]&&(e[t.subject].count+=1)});const s=document.getElementById("hexagon-visualization");s.innerHTML="";for(const[t,{count:c,color:h}]of Object.entries(e)){const g=document.createElement("div");g.className="hexagon",g.style.backgroundColor=c>0?h:"#ffffff",g.style.color=c>0?"white":"black",g.innerHTML=`
        <div class="hexagon-content">
          <p>${t}</p>
          <p>[${c}]</p>
        </div>
      `,s.appendChild(g)}})},N=async()=>{const n=await L(),o=await chrome.storage.sync.get("spreadsheetId");if(o.spreadsheetId)try{if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${o.spreadsheetId}`,{headers:{Authorization:`Bearer ${n}`}})).ok)return o.spreadsheetId}catch{console.log("Stored spreadsheet no longer accessible, creating new one")}const e=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:"Web Page Classifications"},sheets:[{properties:{title:B.SHEET_NAME}}]})});if(!e.ok)throw new Error("Failed to create spreadsheet");const{spreadsheetId:s}=await e.json();return await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s}/values/${B.SHEET_NAME}!A1:C1?valueInputOption=RAW`,{method:"PUT",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({values:[B.HEADERS]})}),await chrome.storage.sync.set({spreadsheetId:s}),s},_=async(n,o,e)=>{const s=await L();if(!s)throw new Error("Not authenticated");const{spreadsheetId:t}=await chrome.storage.sync.get("spreadsheetId");if(!t)throw new Error("No spreadsheet connected");const c=`${B.SHEET_NAME}!A:E`,y=((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${c}`,{headers:{Authorization:`Bearer ${s}`}}).then(d=>d.json())).values||[]).find(d=>d[0]===n&&d[1]===o),f=d=>new Date(d).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});let i;if(y){const d=parseInt(y[2])+1,m=y[3];i=[[n,o,d,f(m),f(e)]]}else i=[[n,o,1,f(e),f(e)]];const l=`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${c}:append?valueInputOption=USER_ENTERED`,p=await fetch(l,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({values:i})});if(!p.ok){const d=await p.json();throw console.error("Sheet API Error:",d),new Error("Failed to append to Google Sheet")}return p.json()},M=()=>{const n=document.createElement("div");n.id="sheet-settings",n.style.marginTop="2px",n.style.borderTop="1px solid #ccc",n.style.paddingTop="10px",chrome.storage.sync.get("spreadsheetId",async o=>{if(o.spreadsheetId){const e=await L(),t=await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${o.spreadsheetId}?fields=properties.title`,{headers:{Authorization:`Bearer ${e}`}})).json();n.innerHTML=`
        <p>Connected to Sheet: ${t.properties.title}</p>
        <button id="disconnect-sheet">Disconnect Sheet</button>
        <button id="open-sheet">Open Sheet</button>
      `}else n.innerHTML=`
        <p>No Google Sheet connected</p>
        <button id="connect-sheet" style="background-color: #008000; &:hover { background-color: #006400; }">Connect to Google Sheets (beta)</button>
      `}),document.body.appendChild(n),document.addEventListener("click",async o=>{if(o.target.id==="connect-sheet")try{const{previousSpreadsheetId:e}=await chrome.storage.sync.get(b.PREVIOUS_SPREADSHEET_ID);if(e)try{const t=await L();if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${e}`,{headers:{Authorization:`Bearer ${t}`}})).ok){await chrome.storage.sync.set({[b.SPREADSHEET_ID]:e}),location.reload();return}}catch{console.log("Previous spreadsheet no longer accessible")}const s=await N();location.reload()}catch(e){console.error("Failed to connect sheet:",e)}else if(o.target.id==="disconnect-sheet"){const{spreadsheetId:e}=await chrome.storage.sync.get(b.SPREADSHEET_ID);e&&await chrome.storage.sync.set({[b.PREVIOUS_SPREADSHEET_ID]:e}),await chrome.storage.sync.remove(b.SPREADSHEET_ID),location.reload()}else if(o.target.id==="open-sheet"){const{spreadsheetId:e}=await chrome.storage.sync.get(b.SPREADSHEET_ID);e&&window.open(`https://docs.google.com/spreadsheets/d/${e}`)}})},U=n=>{const o=["Subject","URL","Count","Initial Timestamp","Latest Timestamp"],e=n.map(s=>[s.subject,s.url,s.count||1,new Date(s.firstTimestamp||s.timestamp).toLocaleString(),new Date(s.lastTimestamp||s.timestamp).toLocaleString()]);return[o,...e].map(s=>s.map(t=>`"${t}"`).join(",")).join(`
`)},z=()=>{chrome.storage.sync.get("responses",n=>{const o=n.responses||[];if(o.length===0){alert("No classification history to download.");return}const e=U(o),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(s),c=document.createElement("a"),h=new Date().toISOString().split("T")[0];c.setAttribute("href",t),c.setAttribute("download",`classification-history-${h}.csv`),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(t)})};
