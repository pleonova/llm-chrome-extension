(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const m of r.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&n(m)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();console.log("popup.js loaded successfully");const A={SCOPES:["https://www.googleapis.com/auth/spreadsheets"],SHEET_NAME:"Classification History",HEADERS:["Subject","URL","Timestamp"]},C={SPREADSHEET_ID:"spreadsheetId",PREVIOUS_SPREADSHEET_ID:"previousSpreadsheetId"},P=async()=>{try{return new Promise((o,s)=>{chrome.identity.getAuthToken({interactive:!0},t=>{chrome.runtime.lastError?s(chrome.runtime.lastError):o(t)})})}catch(o){throw console.error("Auth error:",o),o}},L=10;let E=1;document.addEventListener("DOMContentLoaded",async()=>{const o=document.getElementById("classify");document.getElementById("view-responses"),document.getElementById("responses-list"),document.getElementById("responses-table");const s=async(a,c)=>{const i=new Date().toISOString();chrome.storage.sync.get("responses",d=>{const h=d.responses||[];h.push({subject:a,url:c,timestamp:i}),chrome.storage.sync.set({responses:h},()=>{console.log("Classification stored in Chrome storage:",{subject:a,url:c,timestamp:i})})});try{const{spreadsheetId:d}=await chrome.storage.sync.get("spreadsheetId");d&&(await N(a,c,i),console.log("Classification stored in Google Sheets"))}catch(d){console.error("Failed to store in Google Sheets:",d)}},t=a=>{chrome.storage.sync.get("responses",c=>{const i=c.responses||[];a>=0&&a<i.length&&(i.splice(a,1),chrome.storage.sync.set({responses:i},()=>{console.log(`Removed classification at index ${a}`),n()}))})},n=()=>{chrome.storage.sync.get("responses",a=>{const c=a.responses||[],i=document.getElementById("responses-list"),d=document.getElementById("responses-table");if(i.innerHTML="",c.length===0){console.log("No past classifications found");const l=document.createElement("tr"),g=document.createElement("td");g.colSpan=4,g.textContent="No past classifications found.",g.style.textAlign="center",l.appendChild(g),i.appendChild(l),document.querySelector(".pagination-controls").style.display="none",H();return}const h=[...c].sort((l,g)=>new Date(g.timestamp)-new Date(l.timestamp)),x=Math.ceil(h.length/L),v=(E-1)*L,k=Math.min(v+L,h.length),b=document.getElementById("prev-page"),S=document.getElementById("next-page"),u=document.getElementById("page-info");b.disabled=E===1,S.disabled=E===x,u.textContent=`Page ${E} of ${x}`,document.querySelector(".pagination-controls").style.display="flex",h.slice(v,k).forEach((l,g)=>{const I=document.createElement("tr"),R=document.createElement("td");R.textContent=l.subject||"N/A",I.appendChild(R);const B=document.createElement("td"),T=document.createElement("a");T.href=l.url,T.textContent=l.url.length>50?l.url.substring(0,47)+"...":l.url,T.title=l.url,T.target="_blank",B.appendChild(T),B.style.wordWrap="break-word",B.style.maxWidth="200px",I.appendChild(B);const O=document.createElement("td");O.textContent=new Date(l.timestamp).toLocaleString(),I.appendChild(O);const $=document.createElement("td"),f=document.createElement("button");f.textContent="X",f.style.color="white",f.style.backgroundColor="black",f.style.border="none",f.style.cursor="pointer",f.style.padding="2px 5px",f.style.fontSize="12px",f.style.borderRadius="3px",f.addEventListener("click",()=>{t(h.length-1-(v+g))}),$.appendChild(f),I.appendChild($),i.appendChild(I)}),d.style.display="table",H()})},e=document.getElementById("prev-page"),r=document.getElementById("next-page");e.addEventListener("click",()=>{E>1&&(E--,n())}),r.addEventListener("click",()=>{chrome.storage.sync.get("responses",a=>{const c=a.responses||[],i=Math.ceil(c.length/L);E<i&&(E++,n())})});const m=(a=!1,c)=>{const i=document.getElementById("result"),d=document.getElementById("extracted-text"),h=document.getElementById("source");c.disabled=!0,c.style.backgroundColor="#cccccc",c.innerText="Classifying...",i.innerText="",d.innerText="",d.style.display="none",h.innerText="",chrome.tabs.query({active:!0,currentWindow:!0},x=>{if(x.length===0){console.error("No active tab found"),c.disabled=!1,c.style.backgroundColor="",c.innerText=a?"Classify using Local Model":"Classify",i.innerText="No active tab found!";return}const v=new URL(x[0].url),k={target:{tabId:x[0].id},func:b=>{if(b==="twitter.com"||b==="x.com"){const u=document.querySelector('[data-testid="tweetText"]');return u?{text:u.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const S=["#mw-content-text","main","article"];for(let u of S){const w=document.querySelector(u);if(w&&w.innerText.trim())return{text:w.innerText.substring(0,5e3),source:u}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[v.hostname]};chrome.scripting.executeScript(k,b=>{if(chrome.runtime.lastError){console.error("Error:",chrome.runtime.lastError),c.disabled=!1,c.style.backgroundColor="",c.innerText=a?"Classify using Local Model":"Classify",i.innerText=`Error: ${chrome.runtime.lastError.message}`;return}const S=b[0].result;h.innerText=`Extracted Text Source: ${S.source}`,d.style.display="block",d.innerText=S.text,chrome.runtime.sendMessage({action:"classifyPage",content:S.text,useLocalModel:a},u=>{if(c.disabled=!1,c.style.backgroundColor="",c.innerText=a?"Classify using Local Model":"Classify",u&&u.subject){i.innerHTML=`This page is classified as: <span>${u.subject}</span>`,s(u.subject,x[0].url);const w=document.getElementById("explanation");if(w&&w.remove(),u.explanation){const l=document.createElement("div");l.id="explanation",l.innerHTML=`<strong>Explanation:</strong> <em>${u.explanation}</em>`,l.style.marginBottom="20px";const g=document.getElementById("view-responses");g.parentNode.insertBefore(l,g)}}else i.innerText="Classification failed."})})})};o?o.addEventListener("click",()=>m(!1,o)):console.error("Classify button not found");const p=document.getElementById("view-responses");p?p.addEventListener("click",()=>{const a=p.querySelector(".caret"),c=p.querySelector(".expander-text"),i=document.getElementById("hexagon-visualization"),d=document.getElementById("responses-table");document.getElementById("download-csv"),a.classList.contains("expanded")?(i.style.display="none",d.style.display="none",a.classList.remove("expanded"),c.textContent="View Past Classifications"):(n(),i.style.display="flex",d.style.display="table",a.classList.add("expanded"),c.textContent="Hide Past Classifications")}):console.error("Expander not found");const y=document.getElementById("classifyLocalButton");y?chrome.runtime.sendMessage({action:"checkModelAvailability"},a=>{a?(y.style.backgroundColor="",y.addEventListener("click",()=>m(!0,y))):(y.disabled=!0,y.style.backgroundColor="#cccccc",y.innerText="No local model available",y.style.cursor="not-allowed")}):console.error("Local classification button not found");const D=document.getElementById("download-csv");D?D.addEventListener("click",U):console.error("Download CSV button not found"),M()});const H=()=>{chrome.storage.sync.get("responses",o=>{const s=o.responses||[],t={Mathematics:{count:0,color:"#F9584B"},Science:{count:0,color:"#E6B710"},"Social Studies":{count:0,color:"#32B7A9"},"Language Arts":{count:0,color:"#4E62E0"}};s.forEach(e=>{t[e.subject]&&(t[e.subject].count+=1)});const n=document.getElementById("hexagon-visualization");n.innerHTML="";for(const[e,{count:r,color:m}]of Object.entries(t)){const p=document.createElement("div");p.className="hexagon",p.style.backgroundColor=r>0?m:"#ffffff",p.style.color=r>0?"white":"black",p.innerHTML=`
        <div class="hexagon-content">
          <p>${e}</p>
          <p>[${r}]</p>
        </div>
      `,n.appendChild(p)}})},j=async()=>{const o=await P(),s=await chrome.storage.sync.get("spreadsheetId");if(s.spreadsheetId)try{if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s.spreadsheetId}`,{headers:{Authorization:`Bearer ${o}`}})).ok)return s.spreadsheetId}catch{console.log("Stored spreadsheet no longer accessible, creating new one")}const t=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:"Web Page Classifications"},sheets:[{properties:{title:A.SHEET_NAME}}]})});if(!t.ok)throw new Error("Failed to create spreadsheet");const{spreadsheetId:n}=await t.json();return await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${n}/values/${A.SHEET_NAME}!A1:C1?valueInputOption=RAW`,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({values:[A.HEADERS]})}),await chrome.storage.sync.set({spreadsheetId:n}),n},N=async(o,s,t)=>{const n=await P();if(!n)throw new Error("Not authenticated");const{spreadsheetId:e}=await chrome.storage.sync.get("spreadsheetId");if(!e)throw new Error("No spreadsheet connected");const r=`${A.SHEET_NAME}!A:C`,m=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${r}:append?valueInputOption=USER_ENTERED`,p=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({values:[[o,s,new Date(t).toLocaleString()]]})});if(!p.ok){const y=await p.json();throw console.error("Sheet API Error:",y),new Error("Failed to append to Google Sheet")}return p.json()},M=()=>{const o=document.createElement("div");o.id="sheet-settings",o.style.marginTop="20px",o.style.borderTop="1px solid #ccc",o.style.paddingTop="10px",chrome.storage.sync.get("spreadsheetId",async s=>{if(s.spreadsheetId){const t=await P(),e=await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s.spreadsheetId}?fields=properties.title`,{headers:{Authorization:`Bearer ${t}`}})).json();o.innerHTML=`
        <p>Connected to Sheet: ${e.properties.title}</p>
        <button id="disconnect-sheet">Disconnect Sheet</button>
        <button id="open-sheet">Open Sheet</button>
      `}else o.innerHTML=`
        <p>No Google Sheet connected</p>
        <button id="connect-sheet" style="background-color: #008000; &:hover { background-color: #006400; }">Connect to Google Sheets (beta)</button>
      `}),document.body.appendChild(o),document.addEventListener("click",async s=>{if(s.target.id==="connect-sheet")try{const{previousSpreadsheetId:t}=await chrome.storage.sync.get(C.PREVIOUS_SPREADSHEET_ID);if(t)try{const e=await P();if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}`,{headers:{Authorization:`Bearer ${e}`}})).ok){await chrome.storage.sync.set({[C.SPREADSHEET_ID]:t}),location.reload();return}}catch{console.log("Previous spreadsheet no longer accessible")}const n=await j();location.reload()}catch(t){console.error("Failed to connect sheet:",t)}else if(s.target.id==="disconnect-sheet"){const{spreadsheetId:t}=await chrome.storage.sync.get(C.SPREADSHEET_ID);t&&await chrome.storage.sync.set({[C.PREVIOUS_SPREADSHEET_ID]:t}),await chrome.storage.sync.remove(C.SPREADSHEET_ID),location.reload()}else if(s.target.id==="open-sheet"){const{spreadsheetId:t}=await chrome.storage.sync.get(C.SPREADSHEET_ID);t&&window.open(`https://docs.google.com/spreadsheets/d/${t}`)}})},_=o=>{const s=["Subject","URL","Timestamp"],t=o.map(n=>[n.subject,n.url,new Date(n.timestamp).toLocaleString()]);return[s,...t].map(n=>n.map(e=>`"${e}"`).join(",")).join(`
`)},U=()=>{chrome.storage.sync.get("responses",o=>{const s=o.responses||[];if(s.length===0){alert("No classification history to download.");return}const t=_(s),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),e=URL.createObjectURL(n),r=document.createElement("a"),m=new Date().toISOString().split("T")[0];r.setAttribute("href",e),r.setAttribute("download",`classification-history-${m}.csv`),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(e)})};
