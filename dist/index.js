(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const g of c.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&o(g)}).observe(document,{childList:!0,subtree:!0});function t(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(s){if(s.ep)return;s.ep=!0;const c=t(s);fetch(s.href,c)}})();console.log("popup.js loaded successfully");const B={SCOPES:["https://www.googleapis.com/auth/spreadsheets"],SHEET_NAME:"Classification History",HEADERS:["Subject","URL","Count","Initial Timestamp","Latest Timestamp"]},I={SPREADSHEET_ID:"spreadsheetId",PREVIOUS_SPREADSHEET_ID:"previousSpreadsheetId"},L=async()=>{try{return new Promise((n,a)=>{chrome.identity.getAuthToken({interactive:!0},t=>{chrome.runtime.lastError?a(chrome.runtime.lastError):n(t)})})}catch(n){throw console.error("Auth error:",n),n}},v=5;let b=1;async function O(){const n=document.getElementById("extracted-text"),a=document.getElementById("source");try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t){console.error("No active tab found");return}const o=new URL(t.url),s={target:{tabId:t.id},func:y=>{if(y==="twitter.com"||y==="x.com"){const E=document.querySelector('[data-testid="tweetText"]');return E?{text:E.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const f=["#mw-content-text","main","article"];for(let E of f){const i=document.querySelector(E);if(i&&i.innerText.trim())return{text:i.innerText.substring(0,5e3),source:E}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[o.hostname]},[c]=await chrome.scripting.executeScript(s),g=c.result;a.innerText=`Extracted Text Source: ${g.source}`,n.style.display="block",n.innerText=g.text}catch(t){console.error("Error extracting text:",t),n.style.display="block",n.innerText="Error extracting text from page."}}document.addEventListener("DOMContentLoaded",async()=>{const n=document.getElementById("classify");document.getElementById("view-responses"),document.getElementById("responses-list"),document.getElementById("responses-table"),await O();const a=async(i,l)=>{const p=new Date().toISOString();chrome.storage.sync.get("responses",d=>{let u=d.responses||[];const h=u.findIndex(T=>T.url===l&&T.subject===i);if(h!==-1){const T=Number(u[h].count)||1;u[h]={...u[h],count:T+1,lastTimestamp:p}}else u.push({subject:i,url:l,count:1,firstTimestamp:p,lastTimestamp:p});chrome.storage.sync.set({responses:u},()=>{o()})});try{const{spreadsheetId:d}=await chrome.storage.sync.get("spreadsheetId");d&&(await H(i,l,p),console.log("Classification stored in Google Sheets"))}catch(d){console.error("Failed to store in Google Sheets:",d)}},t=(i,l)=>{chrome.storage.sync.get("responses",p=>{const u=(p.responses||[]).filter(h=>!(h.url===i&&h.subject===l));chrome.storage.sync.set({responses:u},()=>{console.log("Classification removed"),o()})})},o=()=>{chrome.storage.sync.get("responses",i=>{const l=i.responses||[],p=document.getElementById("responses-list");if(document.getElementById("responses-table"),p.innerHTML="",l.length===0){console.log("No past classifications found");const r=document.createElement("tr"),e=document.createElement("td");e.colSpan=6,e.textContent="No past classifications found.",e.style.textAlign="center",r.appendChild(e),p.appendChild(r),document.querySelector(".pagination-controls").style.display="none",$();return}const d=l.reduce((r,e)=>{const m=`${e.url}-${e.subject}`;return r[m]?r[m]={...e,count:e.count||r[m].count,firstTimestamp:e.firstTimestamp<r[m].firstTimestamp?e.firstTimestamp:r[m].firstTimestamp,lastTimestamp:e.lastTimestamp>r[m].lastTimestamp?e.lastTimestamp:r[m].lastTimestamp}:r[m]={...e,count:e.count||1,firstTimestamp:e.firstTimestamp||e.timestamp,lastTimestamp:e.lastTimestamp||e.timestamp},r},{}),u=Object.values(d).sort((r,e)=>new Date(e.lastTimestamp)-new Date(r.lastTimestamp)),h=Math.ceil(u.length/v),T=(b-1)*v,A=Math.min(T+v,u.length),C=u.slice(T,A);document.querySelector(".pagination-controls").style.display="block",document.getElementById("prev-page").disabled=b===1,document.getElementById("next-page").disabled=b===h,document.getElementById("page-info").textContent=`Page ${b} of ${h||1}`,C.forEach(r=>{const e=document.createElement("tr"),m=document.createElement("td");m.textContent=r.subject||"N/A",e.appendChild(m);const w=document.createElement("td"),S=document.createElement("a");S.href=r.url,S.textContent=r.url.length>50?r.url.substring(0,47)+"...":r.url,S.title=r.url,S.target="_blank",w.appendChild(S),w.style.wordWrap="break-word",w.style.maxWidth="200px",e.appendChild(w);const D=document.createElement("td");D.textContent=r.count,e.appendChild(D);const k=document.createElement("td");k.textContent=new Date(r.firstTimestamp).toLocaleString(),e.appendChild(k);const P=document.createElement("td");P.textContent=new Date(r.lastTimestamp).toLocaleString(),e.appendChild(P);const R=document.createElement("td"),x=document.createElement("button");x.textContent="X",x.style.color="white",x.style.backgroundColor="black",x.style.border="none",x.style.cursor="pointer",x.style.padding="2px 5px",x.style.fontSize="12px",x.style.borderRadius="3px",x.addEventListener("click",()=>{t(r.url,r.subject)}),R.appendChild(x),e.appendChild(R),p.appendChild(e)}),$()})},s=document.getElementById("prev-page"),c=document.getElementById("next-page");s.addEventListener("click",()=>{b>1&&(b--,o())}),c.addEventListener("click",()=>{chrome.storage.sync.get("responses",i=>{const l=i.responses||[],p=Math.ceil(l.length/v);b<p&&(b++,o())})});const g=(i=!1,l)=>{const p=document.getElementById("result"),d=document.getElementById("extracted-text"),u=document.getElementById("source");l.disabled=!0,l.style.backgroundColor="#cccccc",l.innerText="Classifying...",p.innerText="",d.innerText="",d.style.display="none",u.innerText="",chrome.tabs.query({active:!0,currentWindow:!0},h=>{if(h.length===0){console.error("No active tab found"),l.disabled=!1,l.style.backgroundColor="",l.innerText=i?"Classify using Local Model":"Classify",p.innerText="No active tab found!";return}const T=new URL(h[0].url),A={target:{tabId:h[0].id},func:C=>{if(C==="twitter.com"||C==="x.com"){const e=document.querySelector('[data-testid="tweetText"]');return e?{text:e.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const r=["#mw-content-text","main","article"];for(let e of r){const m=document.querySelector(e);if(m&&m.innerText.trim())return{text:m.innerText.substring(0,5e3),source:e}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[T.hostname]};chrome.scripting.executeScript(A,C=>{if(chrome.runtime.lastError){console.error("Error:",chrome.runtime.lastError),l.disabled=!1,l.style.backgroundColor="",l.innerText=i?"Classify using Local Model":"Classify",p.innerText=`Error: ${chrome.runtime.lastError.message}`;return}const r=C[0].result;u.innerText=`Extracted Text Source: ${r.source}`,d.style.display="block",d.innerText=r.text,chrome.runtime.sendMessage({action:"classifyPage",content:r.text,useLocalModel:i},e=>{if(l.disabled=!1,l.style.backgroundColor="",l.innerText=i?"Classify using Local Model":"Classify",e&&e.subject){p.innerHTML=`This page is classified as: <span>${e.subject}</span>`,a(e.subject,h[0].url);const m=document.getElementById("explanation");if(m&&m.remove(),e.explanation){const w=document.createElement("div");w.id="explanation",w.innerHTML=`<strong>Explanation:</strong> <em>${e.explanation}</em>`,w.style.marginBottom="20px";const S=document.getElementById("view-responses");S.parentNode.insertBefore(w,S)}}else p.innerText="Classification failed."})})})};n?n.addEventListener("click",()=>g(!1,n)):console.error("Classify button not found");const y=document.getElementById("view-responses");y?y.addEventListener("click",()=>{const i=y.querySelector(".caret"),l=y.querySelector(".expander-text"),p=document.getElementById("hexagon-visualization"),d=document.getElementById("responses-table");document.getElementById("download-csv"),i.classList.contains("expanded")?(p.style.display="none",d.style.display="none",i.classList.remove("expanded"),l.textContent="View Past Classifications"):(o(),p.style.display="flex",d.style.display="table",i.classList.add("expanded"),l.textContent="Hide Past Classifications")}):console.error("Expander not found");const f=document.getElementById("classifyLocalButton");f?chrome.runtime.sendMessage({action:"checkModelAvailability"},i=>{i?(f.style.backgroundColor="",f.addEventListener("click",()=>g(!0,f))):(f.disabled=!0,f.style.backgroundColor="#cccccc",f.innerText="No local model available",f.style.cursor="not-allowed")}):console.error("Local classification button not found");const E=document.getElementById("download-csv");E?E.addEventListener("click",_):console.error("Download CSV button not found"),N()});const $=()=>{chrome.storage.sync.get("responses",n=>{const a=n.responses||[],t={Mathematics:{count:0,color:"#F9584B"},Science:{count:0,color:"#E6B710"},"Social Studies":{count:0,color:"#32B7A9"},"Language Arts":{count:0,color:"#4E62E0"}};a.forEach(s=>{t[s.subject]&&(t[s.subject].count+=1)});const o=document.getElementById("hexagon-visualization");o.innerHTML="";for(const[s,{count:c,color:g}]of Object.entries(t)){const y=document.createElement("div");y.className="hexagon",y.style.backgroundColor=c>0?g:"#ffffff",y.style.color=c>0?"white":"black",y.innerHTML=`
        <div class="hexagon-content">
          <p>${s}</p>
          <p>[${c}]</p>
        </div>
      `,o.appendChild(y)}})},j=async()=>{const n=await L(),a=await chrome.storage.sync.get("spreadsheetId");if(a.spreadsheetId)try{if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${a.spreadsheetId}`,{headers:{Authorization:`Bearer ${n}`}})).ok)return a.spreadsheetId}catch{console.log("Stored spreadsheet no longer accessible, creating new one")}const t=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:"Web Page Classifications"},sheets:[{properties:{title:B.SHEET_NAME}}]})});if(!t.ok)throw new Error("Failed to create spreadsheet");const{spreadsheetId:o}=await t.json();return await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/${B.SHEET_NAME}!A1:C1?valueInputOption=RAW`,{method:"PUT",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({values:[B.HEADERS]})}),await chrome.storage.sync.set({spreadsheetId:o}),o},H=async(n,a,t)=>{const o=await L();if(!o)throw new Error("Not authenticated");const{spreadsheetId:s}=await chrome.storage.sync.get("spreadsheetId");if(!s)throw new Error("No spreadsheet connected");const c=`${B.SHEET_NAME}!A:E`,f=((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s}/values/${c}`,{headers:{Authorization:`Bearer ${o}`}}).then(d=>d.json())).values||[]).find(d=>d[0]===n&&d[1]===a),E=d=>new Date(d).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});let i;if(f){const d=parseInt(f[2])+1,u=f[3];i=[[n,a,d,E(u),E(t)]]}else i=[[n,a,1,E(t),E(t)]];const l=`https://sheets.googleapis.com/v4/spreadsheets/${s}/values/${c}:append?valueInputOption=USER_ENTERED`,p=await fetch(l,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({values:i})});if(!p.ok){const d=await p.json();throw console.error("Sheet API Error:",d),new Error("Failed to append to Google Sheet")}return p.json()},N=()=>{const n=document.createElement("div");n.id="sheet-settings",n.style.marginTop="2px",n.style.borderTop="1px solid #ccc",n.style.paddingTop="10px",chrome.storage.sync.get("spreadsheetId",async a=>{if(a.spreadsheetId){const t=await L(),s=await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${a.spreadsheetId}?fields=properties.title`,{headers:{Authorization:`Bearer ${t}`}})).json();n.innerHTML=`
        <p>Connected to Sheet: ${s.properties.title}</p>
        <button id="disconnect-sheet">Disconnect Sheet</button>
        <button id="open-sheet">Open Sheet</button>
      `}else n.innerHTML=`
        <p>No Google Sheet connected</p>
        <button id="connect-sheet" style="background-color: #008000; &:hover { background-color: #006400; }">Connect to Google Sheets (beta)</button>
      `}),document.body.appendChild(n),document.addEventListener("click",async a=>{if(a.target.id==="connect-sheet")try{const{previousSpreadsheetId:t}=await chrome.storage.sync.get(I.PREVIOUS_SPREADSHEET_ID);if(t)try{const s=await L();if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}`,{headers:{Authorization:`Bearer ${s}`}})).ok){await chrome.storage.sync.set({[I.SPREADSHEET_ID]:t}),location.reload();return}}catch{console.log("Previous spreadsheet no longer accessible")}const o=await j();location.reload()}catch(t){console.error("Failed to connect sheet:",t)}else if(a.target.id==="disconnect-sheet"){const{spreadsheetId:t}=await chrome.storage.sync.get(I.SPREADSHEET_ID);t&&await chrome.storage.sync.set({[I.PREVIOUS_SPREADSHEET_ID]:t}),await chrome.storage.sync.remove(I.SPREADSHEET_ID),location.reload()}else if(a.target.id==="open-sheet"){const{spreadsheetId:t}=await chrome.storage.sync.get(I.SPREADSHEET_ID);t&&window.open(`https://docs.google.com/spreadsheets/d/${t}`)}})},M=n=>{const a=["Subject","URL","Count","Initial Timestamp","Latest Timestamp"],t=n.map(o=>[o.subject,o.url,o.count||1,new Date(o.firstTimestamp||o.timestamp).toLocaleString(),new Date(o.lastTimestamp||o.timestamp).toLocaleString()]);return[a,...t].map(o=>o.map(s=>`"${s}"`).join(",")).join(`
`)},_=()=>{chrome.storage.sync.get("responses",n=>{const a=n.responses||[];if(a.length===0){alert("No classification history to download.");return}const t=M(a),o=new Blob([t],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(o),c=document.createElement("a"),g=new Date().toISOString().split("T")[0];c.setAttribute("href",s),c.setAttribute("download",`classification-history-${g}.csv`),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s)})};
