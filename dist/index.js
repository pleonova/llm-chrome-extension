(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const c of t)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&o(f)}).observe(document,{childList:!0,subtree:!0});function s(t){const c={};return t.integrity&&(c.integrity=t.integrity),t.referrerPolicy&&(c.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?c.credentials="include":t.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(t){if(t.ep)return;t.ep=!0;const c=s(t);fetch(t.href,c)}})();console.log("popup.js loaded successfully");const B={SCOPES:["https://www.googleapis.com/auth/spreadsheets"],SHEET_NAME:"Classification History",HEADERS:["Subject","URL","Count","Initial Timestamp","Latest Timestamp"]},I={SPREADSHEET_ID:"spreadsheetId",PREVIOUS_SPREADSHEET_ID:"previousSpreadsheetId"},L=async()=>{try{return new Promise((r,a)=>{chrome.identity.getAuthToken({interactive:!0},s=>{chrome.runtime.lastError?a(chrome.runtime.lastError):r(s)})})}catch(r){throw console.error("Auth error:",r),r}},v=5;let w=1;document.addEventListener("DOMContentLoaded",async()=>{const r=document.getElementById("classify");document.getElementById("view-responses"),document.getElementById("responses-list"),document.getElementById("responses-table");const a=async(p,i)=>{const d=new Date().toISOString();chrome.storage.sync.get("responses",l=>{let m=l.responses||[];const h=m.findIndex(x=>x.url===i&&x.subject===p);if(h!==-1){const x=Number(m[h].count)||1;m[h]={...m[h],count:x+1,lastTimestamp:d}}else m.push({subject:p,url:i,count:1,firstTimestamp:d,lastTimestamp:d});chrome.storage.sync.set({responses:m},()=>{o()})});try{const{spreadsheetId:l}=await chrome.storage.sync.get("spreadsheetId");l&&(await j(p,i,d),console.log("Classification stored in Google Sheets"))}catch(l){console.error("Failed to store in Google Sheets:",l)}},s=(p,i)=>{chrome.storage.sync.get("responses",d=>{const m=(d.responses||[]).filter(h=>!(h.url===p&&h.subject===i));chrome.storage.sync.set({responses:m},()=>{console.log("Classification removed"),o()})})},o=()=>{chrome.storage.sync.get("responses",p=>{const i=p.responses||[],d=document.getElementById("responses-list");if(document.getElementById("responses-table"),d.innerHTML="",i.length===0){console.log("No past classifications found");const n=document.createElement("tr"),e=document.createElement("td");e.colSpan=6,e.textContent="No past classifications found.",e.style.textAlign="center",n.appendChild(e),d.appendChild(n),document.querySelector(".pagination-controls").style.display="none",$();return}const l=i.reduce((n,e)=>{const u=`${e.url}-${e.subject}`;return n[u]?n[u]={...e,count:e.count||n[u].count,firstTimestamp:e.firstTimestamp<n[u].firstTimestamp?e.firstTimestamp:n[u].firstTimestamp,lastTimestamp:e.lastTimestamp>n[u].lastTimestamp?e.lastTimestamp:n[u].lastTimestamp}:n[u]={...e,count:e.count||1,firstTimestamp:e.firstTimestamp||e.timestamp,lastTimestamp:e.lastTimestamp||e.timestamp},n},{}),m=Object.values(l).sort((n,e)=>new Date(e.lastTimestamp)-new Date(n.lastTimestamp)),h=Math.ceil(m.length/v),x=(w-1)*v,A=Math.min(x+v,m.length),C=m.slice(x,A);document.querySelector(".pagination-controls").style.display="block",document.getElementById("prev-page").disabled=w===1,document.getElementById("next-page").disabled=w===h,document.getElementById("page-info").textContent=`Page ${w} of ${h||1}`,C.forEach(n=>{const e=document.createElement("tr"),u=document.createElement("td");u.textContent=n.subject||"N/A",e.appendChild(u);const T=document.createElement("td"),S=document.createElement("a");S.href=n.url,S.textContent=n.url.length>50?n.url.substring(0,47)+"...":n.url,S.title=n.url,S.target="_blank",T.appendChild(S),T.style.wordWrap="break-word",T.style.maxWidth="200px",e.appendChild(T);const D=document.createElement("td");D.textContent=n.count,e.appendChild(D);const k=document.createElement("td");k.textContent=new Date(n.firstTimestamp).toLocaleString(),e.appendChild(k);const P=document.createElement("td");P.textContent=new Date(n.lastTimestamp).toLocaleString(),e.appendChild(P);const R=document.createElement("td"),E=document.createElement("button");E.textContent="X",E.style.color="white",E.style.backgroundColor="black",E.style.border="none",E.style.cursor="pointer",E.style.padding="2px 5px",E.style.fontSize="12px",E.style.borderRadius="3px",E.addEventListener("click",()=>{s(n.url,n.subject)}),R.appendChild(E),e.appendChild(R),d.appendChild(e)}),$()})},t=document.getElementById("prev-page"),c=document.getElementById("next-page");t.addEventListener("click",()=>{w>1&&(w--,o())}),c.addEventListener("click",()=>{chrome.storage.sync.get("responses",p=>{const i=p.responses||[],d=Math.ceil(i.length/v);w<d&&(w++,o())})});const f=(p=!1,i)=>{const d=document.getElementById("result"),l=document.getElementById("extracted-text"),m=document.getElementById("source");i.disabled=!0,i.style.backgroundColor="#cccccc",i.innerText="Classifying...",d.innerText="",l.innerText="",l.style.display="none",m.innerText="",chrome.tabs.query({active:!0,currentWindow:!0},h=>{if(h.length===0){console.error("No active tab found"),i.disabled=!1,i.style.backgroundColor="",i.innerText=p?"Classify using Local Model":"Classify",d.innerText="No active tab found!";return}const x=new URL(h[0].url),A={target:{tabId:h[0].id},func:C=>{if(C==="twitter.com"||C==="x.com"){const e=document.querySelector('[data-testid="tweetText"]');return e?{text:e.innerText,source:"tweet"}:{text:"Unable to extract tweet text.",source:"tweet"}}const n=["#mw-content-text","main","article"];for(let e of n){const u=document.querySelector(e);if(u&&u.innerText.trim())return{text:u.innerText.substring(0,5e3),source:e}}return{text:document.body.innerText.substring(0,5e3),source:"all"}},args:[x.hostname]};chrome.scripting.executeScript(A,C=>{if(chrome.runtime.lastError){console.error("Error:",chrome.runtime.lastError),i.disabled=!1,i.style.backgroundColor="",i.innerText=p?"Classify using Local Model":"Classify",d.innerText=`Error: ${chrome.runtime.lastError.message}`;return}const n=C[0].result;m.innerText=`Extracted Text Source: ${n.source}`,l.style.display="block",l.innerText=n.text,chrome.runtime.sendMessage({action:"classifyPage",content:n.text,useLocalModel:p},e=>{if(i.disabled=!1,i.style.backgroundColor="",i.innerText=p?"Classify using Local Model":"Classify",e&&e.subject){d.innerHTML=`This page is classified as: <span>${e.subject}</span>`,a(e.subject,h[0].url);const u=document.getElementById("explanation");if(u&&u.remove(),e.explanation){const T=document.createElement("div");T.id="explanation",T.innerHTML=`<strong>Explanation:</strong> <em>${e.explanation}</em>`,T.style.marginBottom="20px";const S=document.getElementById("view-responses");S.parentNode.insertBefore(T,S)}}else d.innerText="Classification failed."})})})};r?r.addEventListener("click",()=>f(!1,r)):console.error("Classify button not found");const y=document.getElementById("view-responses");y?y.addEventListener("click",()=>{const p=y.querySelector(".caret"),i=y.querySelector(".expander-text"),d=document.getElementById("hexagon-visualization"),l=document.getElementById("responses-table");document.getElementById("download-csv"),p.classList.contains("expanded")?(d.style.display="none",l.style.display="none",p.classList.remove("expanded"),i.textContent="View Past Classifications"):(o(),d.style.display="flex",l.style.display="table",p.classList.add("expanded"),i.textContent="Hide Past Classifications")}):console.error("Expander not found");const g=document.getElementById("classifyLocalButton");g?chrome.runtime.sendMessage({action:"checkModelAvailability"},p=>{p?(g.style.backgroundColor="",g.addEventListener("click",()=>f(!0,g))):(g.disabled=!0,g.style.backgroundColor="#cccccc",g.innerText="No local model available",g.style.cursor="not-allowed")}):console.error("Local classification button not found");const b=document.getElementById("download-csv");b?b.addEventListener("click",M):console.error("Download CSV button not found"),H()});const $=()=>{chrome.storage.sync.get("responses",r=>{const a=r.responses||[],s={Mathematics:{count:0,color:"#F9584B"},Science:{count:0,color:"#E6B710"},"Social Studies":{count:0,color:"#32B7A9"},"Language Arts":{count:0,color:"#4E62E0"}};a.forEach(t=>{s[t.subject]&&(s[t.subject].count+=1)});const o=document.getElementById("hexagon-visualization");o.innerHTML="";for(const[t,{count:c,color:f}]of Object.entries(s)){const y=document.createElement("div");y.className="hexagon",y.style.backgroundColor=c>0?f:"#ffffff",y.style.color=c>0?"white":"black",y.innerHTML=`
        <div class="hexagon-content">
          <p>${t}</p>
          <p>[${c}]</p>
        </div>
      `,o.appendChild(y)}})},O=async()=>{const r=await L(),a=await chrome.storage.sync.get("spreadsheetId");if(a.spreadsheetId)try{if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${a.spreadsheetId}`,{headers:{Authorization:`Bearer ${r}`}})).ok)return a.spreadsheetId}catch{console.log("Stored spreadsheet no longer accessible, creating new one")}const s=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:"Web Page Classifications"},sheets:[{properties:{title:B.SHEET_NAME}}]})});if(!s.ok)throw new Error("Failed to create spreadsheet");const{spreadsheetId:o}=await s.json();return await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/${B.SHEET_NAME}!A1:C1?valueInputOption=RAW`,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({values:[B.HEADERS]})}),await chrome.storage.sync.set({spreadsheetId:o}),o},j=async(r,a,s)=>{const o=await L();if(!o)throw new Error("Not authenticated");const{spreadsheetId:t}=await chrome.storage.sync.get("spreadsheetId");if(!t)throw new Error("No spreadsheet connected");const c=`${B.SHEET_NAME}!A:E`,g=((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${c}`,{headers:{Authorization:`Bearer ${o}`}}).then(l=>l.json())).values||[]).find(l=>l[0]===r&&l[1]===a),b=l=>new Date(l).toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});let p;if(g){const l=parseInt(g[2])+1,m=g[3];p=[[r,a,l,b(m),b(s)]]}else p=[[r,a,1,b(s),b(s)]];const i=`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${c}:append?valueInputOption=USER_ENTERED`,d=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({values:p})});if(!d.ok){const l=await d.json();throw console.error("Sheet API Error:",l),new Error("Failed to append to Google Sheet")}return d.json()},H=()=>{const r=document.createElement("div");r.id="sheet-settings",r.style.marginTop="2px",r.style.borderTop="1px solid #ccc",r.style.paddingTop="10px",chrome.storage.sync.get("spreadsheetId",async a=>{if(a.spreadsheetId){const s=await L(),t=await(await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${a.spreadsheetId}?fields=properties.title`,{headers:{Authorization:`Bearer ${s}`}})).json();r.innerHTML=`
        <p>Connected to Sheet: ${t.properties.title}</p>
        <button id="disconnect-sheet">Disconnect Sheet</button>
        <button id="open-sheet">Open Sheet</button>
      `}else r.innerHTML=`
        <p>No Google Sheet connected</p>
        <button id="connect-sheet" style="background-color: #008000; &:hover { background-color: #006400; }">Connect to Google Sheets (beta)</button>
      `}),document.body.appendChild(r),document.addEventListener("click",async a=>{if(a.target.id==="connect-sheet")try{const{previousSpreadsheetId:s}=await chrome.storage.sync.get(I.PREVIOUS_SPREADSHEET_ID);if(s)try{const t=await L();if((await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${s}`,{headers:{Authorization:`Bearer ${t}`}})).ok){await chrome.storage.sync.set({[I.SPREADSHEET_ID]:s}),location.reload();return}}catch{console.log("Previous spreadsheet no longer accessible")}const o=await O();location.reload()}catch(s){console.error("Failed to connect sheet:",s)}else if(a.target.id==="disconnect-sheet"){const{spreadsheetId:s}=await chrome.storage.sync.get(I.SPREADSHEET_ID);s&&await chrome.storage.sync.set({[I.PREVIOUS_SPREADSHEET_ID]:s}),await chrome.storage.sync.remove(I.SPREADSHEET_ID),location.reload()}else if(a.target.id==="open-sheet"){const{spreadsheetId:s}=await chrome.storage.sync.get(I.SPREADSHEET_ID);s&&window.open(`https://docs.google.com/spreadsheets/d/${s}`)}})},N=r=>{const a=["Subject","URL","Count","Initial Timestamp","Latest Timestamp"],s=r.map(o=>[o.subject,o.url,o.count||1,new Date(o.firstTimestamp||o.timestamp).toLocaleString(),new Date(o.lastTimestamp||o.timestamp).toLocaleString()]);return[a,...s].map(o=>o.map(t=>`"${t}"`).join(",")).join(`
`)},M=()=>{chrome.storage.sync.get("responses",r=>{const a=r.responses||[];if(a.length===0){alert("No classification history to download.");return}const s=N(a),o=new Blob([s],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(o),c=document.createElement("a"),f=new Date().toISOString().split("T")[0];c.setAttribute("href",t),c.setAttribute("download",`classification-history-${f}.csv`),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(t)})};
